
(function($){$.widget("asm.animalchooser",{options:{id:0,rec:{},node:null,dialog:null,display:null,filter:"all"},_create:function(){var h=['<div class="animalchooser">','<input class="animalchooser-oopostcode" type="hidden" value="" />','<input class="animalchooser-bipostcode" type="hidden" value = "" />','<table style="margin-left: 0px; margin-right: 0px; width: 100%">','<tr>','<td class="animalchooser-display">','</td>','<td valign="top" align="right">','<button class="animalchooser-link-find">'+_("Select an animal")+'</button>','<button class="animalchooser-link-clear">'+_("Clear")+'</button>','</td>','</tr>','</table>','<div class="animalchooser-find" style="display: none" title="'+html.title(_("Find animal"))+'">','<input type="text" class="asm-textbox" />','<button>'+_("Search")+'</button>','<img src="static/images/wait/wait16trans.gif" />','<table width="100%">','<thead>','<tr class="ui-widget-header">','<th></th>','<th>'+_("Name")+'</th>','<th>'+_("Code")+'</th>','<th>'+_("Microchip")+'</th>','<th>'+_("Type")+'</th>','<th>'+_("Species")+'</th>','<th>'+_("Breed")+'</th>','<th>'+_("Sex")+'</th>','</tr>','</thead>','<tbody></tbody>','</table>','</div>','</div>'].join("\n");var node=$(h);var self=this;this.options.node=node;var dialog=node.find(".animalchooser-find");this.options.dialog=dialog;this.options.display=node.find(".animalchooser-display");this.element.parent().append(node);if(this.element.attr("data-filter")){this.options.filter=this.element.attr("data-filter");}
var acbuttons={};acbuttons[_("Cancel")]=function(){$(this).dialog("close");};dialog.dialog({autoOpen:false,height:400,width:800,modal:true,dialogClass:"dialogshadow",show:dlgfx.edit_show,hide:dlgfx.edit_hide,buttons:acbuttons});dialog.find("table").table({floating_header:false});dialog.find("input").keydown(function(event){if(event.keyCode==13){self.find();return false;}});dialog.find("button").button().click(function(){self.find();});dialog.find("img").hide();node.find(".animalchooser-link-find").button({icons:{primary:"ui-icon-search"},text:false}).click(function(){dialog.dialog("open");});node.find(".animalchooser-link-clear").button({icons:{primary:"ui-icon-trash"},text:false}).click(function(){self.clear();});if(self.element.val()!=""&&self.element.val()!="0"){self.loadbyid(self.element.val());}},clear:function(){this.element.val("0");this.options.id=0;this.options.rec={};this.options.display.html("");},loadbyid:function(animalid){this.clear();if(!animalid||animalid=="0"||animalid==""){return;}
var self=this;var formdata="mode=id&id="+animalid;$.ajax({type:"POST",url:"animal_embed",data:formdata,dataType:"text",success:function(data,textStatus,jqXHR){var h="";var animal=jQuery.parseJSON(data);var rec=animal[0];var disp="<a class=\"asm-embed-name\" href=\"animal?id="+rec.ID+"\">"+rec.CODE+" - "+rec.ANIMALNAME+"</a>";self.element.val(rec.ID);self.options.rec=rec;self.options.display.html(disp);self._trigger("loaded",null,rec);common.inject_target();},error:function(jqxhr,textstatus,response){common.console_log(response);}});},find:function(){var self=this;var dialog=this.options.dialog,node=this.options.node;dialog.find("img").show();dialog.find("button").button("disable");var formdata="mode=find&filter="+encodeURIComponent(this.options.filter)+"&q="+encodeURIComponent(dialog.find("input").val());$.ajax({type:"POST",url:"animal_embed",data:formdata,dataType:"text",success:function(data,textStatus,jqXHR){var h="";var animal=jQuery.parseJSON(data);$.each(animal,function(i,a){h+="<tr>";h+="<td>"+html.animal_emblems(a,{showlocation:true})+"</td>";h+="<td><a href=\"#\" data=\""+i+"\">"+a.ANIMALNAME+"</a></td>";h+="<td>"+a.CODE+"</td>";h+="<td>"+a.IDENTICHIPNUMBER+"</td>";h+="<td>"+a.ANIMALTYPENAME+"</td>";h+="<td>"+a.SPECIESNAME+"</td>";h+="<td>"+a.BREEDNAME+"</td>";h+="<td>"+a.SEXNAME+"</td>";h+="</tr>";});dialog.find("table > tbody").html(h);dialog.off("click","a");dialog.on("click","a",function(e){var rec=animal[$(this).attr("data")];self.element.val(rec.ID);self.options.rec=rec;var disp="<a class=\"asm-embed-name\" href=\"animal?id="+rec.ID+"\">"+rec.CODE+" - "+rec.ANIMALNAME+"</a>";self.options.display.html(disp);node.find(".animalchooser-oopostcode").val(rec.ORIGINALOWNERPOSTCODE);node.find(".animalchooser-bipostcode").val(rec.BROUGHTINBYOWNERPOSTCODE);try{validate.dirty(true);}catch(ex){}
dialog.dialog("close");self._trigger("change",null,rec);common.inject_target();});dialog.find("table").trigger("update");dialog.find("img").hide();dialog.find("button").button("enable");},error:function(jqxhr,textstatus,response){dialog.dialog("close");common.console_log(response);dialog.find("img").hide();dialog.find("button").button("enable");}});}});}(jQuery));