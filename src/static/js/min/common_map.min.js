
(function($){google_loaded=false;geo={get_lat_long:function(address,town,city,postcode,callback){if(asm.geoprovider=="nominatim"){this._nominatim_get_lat_long(address,town,city,postcode,callback);}
else if(asm.geoprovider=="google"){this._google_get_lat_long(address,town,city,postcode,callback);}
else if(asm.geoprovider=="mapquest"){this._mapquest_get_lat_long(address,town,city,postcode,callback);}},_google_get_lat_long:function(address,town,city,postcode,callback){var add=address+", "+town+", "+city+", "+postcode;window._googeocallback=function(){var geocoder=new google.maps.Geocoder();geocoder.geocode({'address':add},function(results,status){if(status==google.maps.GeocoderStatus.OK){callback(results[0].geometry.location.lat(),results[0].geometry.location.lng());}
else{callback(0,0);}});};var key="";if(asm.geoproviderkey){key="&key="+asm.geoproviderkey;}
if(google_loaded){window._googeocallback();}
else{$.getScript("//maps.google.com/maps/api/js?v=3.x&sensor=false&async=2{key}&callback=_googeocallback".replace("{key}",key),function(){google_loaded=true;});}},_nominatim_get_lat_long:function(address,town,city,postcode,callback){var add=encodeURIComponent(address+","+town).replace(/ /g,"+");$.getJSON("http://nominatim.openstreetmap.org/search?format=json&q="+add+"&json_callback=?",function(data){if(!data){callback(0,0);}
else{callback(data[0].lat,data[0].lon);}});},_mapquest_get_lat_long:function(address,town,city,postcode,callback){var add=(address+","+town+","+city+","+postcode).replace(/'/g,'');var url="http://www.mapquestapi.com/geocoding/v1/address?";if(asm.geoproviderkey){url+="key="+asm.geoproviderkey+"&";}
url+="outFormat=json&inFormat=json&json=";url+=encodeURIComponent("{location: '"+add+"',options:{maxResults:1}}");$.ajax({type:"POST",dataType:"json",mimeType:"text/json",url:url,success:function(response){if(response.results[0]){var ll=response.results[0].locations[0].latLng;if(ll&&ll.lat){callback(ll.lat,ll.lng);return;}}
return callback(0,0);}});},address_hash:function(address,town,city,postcode){var addrhash=address+town+city+postcode;addrhash=addrhash.replace(/ /g,'').replace(/,/g,'').replace(/\n/g,'');if(addrhash.length>220){addrhash=addrhash.substring(0,220);}
return addrhash;}};mapping={draw_map:function(divid,zoom,latlong,markers){if(asm.mapprovider=="osm"){this._leaflet_draw_map(divid,zoom,latlong,markers);}
else if(asm.mapprovider=="google"){this._google_draw_map(divid,zoom,latlong,markers);}},_leaflet_draw_map:function(divid,zoom,latlong,markers){$("head").append('<link rel="stylesheet" href="'+asm.leafletcss+'" />');$.getScript(asm.leafletjs,function(){var ll=latlong.split(",");var map=L.map(divid).setView([ll[0],ll[1]],15);L.tileLayer(asm.osmmaptiles,{attribution:'&copy; <a target="_blank" href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);L.control.scale().addTo(map);$.each(markers,function(i,v){ll=v.latlong.split(",");var marker=L.marker([ll[0],ll[1]]).addTo(map);if(v.popuptext){marker.bindPopup(v.popuptext);}
if(v.popupactive){marker.openPopup();}});});},_google_draw_map:function(divid,zoom,latlong,markers){window._goomapcallback=function(){var ll=latlong.split(",");var mapOptions={zoom:zoom,center:new google.maps.LatLng(parseFloat(ll[0]),parseFloat(ll[1]))};var map=new google.maps.Map(document.getElementById(divid),mapOptions);$.each(markers,function(i,v){ll=v.latlong.split(",");var marker=new google.maps.Marker({position:new google.maps.LatLng(parseFloat(ll[0]),parseFloat(ll[1])),map:map});var infowindow;if(v.popuptext){infowindow=new google.maps.InfoWindow({content:v.popuptext});google.maps.event.addListener(marker,'click',function(){infowindow.open(map,marker);});}
if(v.popupactive){infowindow.open(map,marker);}});};var key="";if(asm.geoproviderkey){key="&key="+asm.geoproviderkey;}
if(google_loaded){window._goomapcallback();}
else{$.getScript("//maps.google.com/maps/api/js?v=3.x&sensor=false&async=2{key}&callback=_goomapcallback".replace("{key}",key),function(){google_loaded=true;});}}};}(jQuery));