
$(function(){var lastanimal=null;var lastperson=null;var lastretailer=null;var movements={};var choosetypes=[];$.each(controller.movementtypes,function(i,v){if(v.ID==8&&!config.bool("DisableRetailer")){choosetypes.push(v);}
if(v.ID!=8&&v.ID!=9&&v.ID!=10&&v.ID!=11&&v.ID!=12){choosetypes.push(v);}});var dialog={add_title:_("Add movement"),edit_title:_("Edit movement"),close_on_ok:false,autofocus:false,columns:2,fields:[{json_field:"ANIMALID",post_field:"animal",label:_("Animal"),type:"animal"},{json_field:"OWNERID",post_field:"person",label:_("Person"),type:"person"},{json_field:"RETAILERID",post_field:"retailer",label:_("Retailer"),type:"person",personfilter:"retailer",hideif:function(){return config.bool("DisableRetailer");}},{json_field:"ADOPTIONNUMBER",post_field:"adoptionno",label:_("Movement Number"),tooltip:_("A unique number to identify this movement"),type:"text"},{json_field:"INSURANCENUMBER",post_field:"insurance",label:_("Insurance"),tooltip:_("If the shelter provides initial insurance cover to new adopters, the policy number"),type:"text"},{json_field:"RESERVATIONDATE",post_field:"reservationdate",label:_("Reservation Date"),tooltip:_("The date this animal was reserved"),type:"date"},{json_field:"RESERVATIONCANCELLEDDATE",post_field:"reservationcancelled",label:_("Reservation Cancelled"),type:"date"},{type:"nextcol"},{json_field:"MOVEMENTTYPE",post_field:"type",label:_("Movement Type"),type:"select",options:{displayfield:"MOVEMENTTYPE",valuefield:"ID",rows:choosetypes}},{json_field:"MOVEMENTDATE",post_field:"movementdate",label:_("Movement Date"),type:"date"},{json_field:"ISPERMANENTFOSTER",post_field:"permanentfoster",label:_("Permanent Foster"),tooltip:_("Is this a permanent foster?"),type:"check"},{json_field:"ISTRIAL",post_field:"trial",label:_("Trial Adoption"),tooltip:_("Is this a trial adoption?"),type:"check"},{json_field:"TRIALENDDATE",post_field:"trialenddate",label:_("Trial ends on"),tooltip:_("The date the trial adoption is over"),type:"date"},{json_field:"COMMENTS",post_field:"comments",label:_("Comments"),type:"textarea"},{json_field:"RETURNDATE",post_field:"returndate",label:_("Return Date"),type:"date"},{json_field:"RETURNEDREASONID",post_field:"returncategory",label:_("Return Category"),type:"select",options:{displayfield:"REASONNAME",valuefield:"ID",rows:controller.returncategories}},{json_field:"REASONFORRETURN",post_field:"reason",label:_("Reason"),type:"textarea"}]};var table={rows:controller.rows,idcolumn:"ID",edit:function(row){tableform.fields_populate_from_json(dialog.fields,row);movements.type_change();movements.returndate_change();tableform.dialog_show_edit(dialog,row,function(){if(!movements.validation()){tableform.dialog_enable_buttons();return;}
tableform.fields_update_row(dialog.fields,row);movements.set_extra_fields(row);tableform.fields_post(dialog.fields,"mode=update&movementid="+row.ID,controller.name,function(response){tableform.table_update(table);tableform.dialog_close();},function(response){tableform.dialog_error(response);tableform.dialog_enable_buttons();});});},complete:function(row){if(row.ISTRIAL==1&&controller.name=="move_book_trial_adoption"&&row.TRIALENDDATE&&format.date_js(row.TRIALENDDATE)<=new Date()){return true;}
if(row.RESERVATIONCANCELLEDDATE!=null||(row.RETURNDATE!=null&&format.date_js(row.RETURNDATE)<=new Date())){return true;}},columns:[{field:"MOVEMENTNAME",display:_("Type")},{field:"MOVEMENTDATE",display:_("Date"),initialsort:controller.name!="move_book_trial_adoption",initialsortdirection:"desc",formatter:function(row,v){if(row.MOVEMENTTYPE==0){return format.date(row.RESERVATIONDATE);}
return format.date(row.MOVEMENTDATE);}},{field:"RETURNDATE",display:_("Returned"),formatter:tableform.format_date,hideif:function(row){if(controller.name=="move_book_trial_adoption"){return true;}}},{field:"TRIALENDDATE",display:_("Trial ends on"),formatter:tableform.format_date,initialsort:controller.name=="move_book_trial_adoption",initialsortdirection:"desc",hideif:function(row){if(controller.name!="move_book_trial_adoption"){return true;}}},{field:"IMAGE",display:"",formatter:function(row){return'<a href="animal?id='+row.ANIMALID+'"><img src='+html.thumbnail_src(row,"animalthumb")+' style="margin-right: 8px" class="asm-thumbnail thumbnailshadow" /></a>';},hideif:function(row){if(controller.name.indexOf("book")==-1||!config.bool("PicturesInBooks")){return true;}}},{field:"ANIMAL",display:_("Animal"),formatter:function(row){var s="";if(controller.name!="animal_movements"){s=html.animal_emblems(row)+" ";}
return s+'<a href="animal?id='+row.ANIMALID+'">'+row.ANIMALNAME+' - '+row.SHELTERCODE+'</a>';}},{field:"PERSON",display:_("Person"),formatter:function(row){if(row.OWNERID){return edit_header.person_name_link(row,row.OWNERID);}
return"";}},{field:"RETAILER",display:_("Retailer"),formatter:function(row){if(row.RETAILERID){return'<a href="person?id='+row.RETAILERID+'">'+row.RETAILERNAME+'</a>';}
return"";},hideif:function(row){return config.bool("DisableRetailer");}},{field:"OWNERADDRESS",display:_("Address")},{field:"HOMETELEPHONE",display:_("Phone"),formatter:function(row){return row.HOMETELEPHONE+" "+row.WORKTELEPHONE+" "+row.MOBILETELEPHONE;}},{field:"ADOPTIONNUMBER",display:_("Movement Number")}]};var buttons=[{id:"new",text:_("New Movement"),icon:"new",enabled:"always",click:function(){$("#animal").animalchooser("clear");$("#person").personchooser("clear");$("#retailer").personchooser("clear");if(controller.animal){$("#animal").animalchooser("loadbyid",controller.animal.ID);}
if(controller.person){$("#person").personchooser("loadbyid",controller.person.ID);}
$("#type").select("value","0");$("#returncategory").select("value",config.str("AFDefaultReturnReason"));$("#adoptionno").closest("tr").hide();if(controller.name=="move_book_foster"){$("#type").select("value","2");}
if(controller.name=="move_book_recent_adoption"){$("#type").select("value","1");}
if(controller.name=="move_book_trial_adoption"){$("#type").select("value","1");}
tableform.dialog_error();movements.type_change();$("#returndate").val("");movements.returndate_change();tableform.dialog_show_add(dialog,function(){if(!movements.validation()){tableform.dialog_enable_buttons();return;}
tableform.fields_post(dialog.fields,"mode=create",controller.name,function(response){var row={};row.ID=response;tableform.fields_update_row(dialog.fields,row);movements.set_extra_fields(row);row.ADOPTIONNUMBER=format.padleft(response,6);controller.rows.push(row);tableform.table_update(table);tableform.dialog_close();},function(){tableform.dialog_enable_buttons();});});}},{id:"delete",text:_("Delete"),icon:"delete",enabled:"multi",click:function(){tableform.delete_dialog(function(){tableform.buttons_default_state(buttons);var ids=tableform.table_ids(table);common.ajax_post(controller.name,"mode=delete&ids="+ids,function(){tableform.table_remove_selected_from_json(table,controller.rows);tableform.table_update(table);});});}}];movements={render:function(){var s="";s+=tableform.dialog_render(dialog);if(controller.name=="animal_movements"){s+=edit_header.animal_edit_header(controller.animal,"movements",controller.tabcounts);}
else if(controller.name=="person_movements"){s+=edit_header.person_edit_header(controller.person,"movements",controller.tabcounts);}
else{s+=html.content_header(document.title);}
s+=tableform.buttons_render(buttons);s+=tableform.table_render(table);s+=html.content_footer();return s;},bind:function(){if(controller.name=="animal_movements"||controller.name=="person_movements"){$(".asm-tabbar").asmtabs();}
tableform.dialog_bind(dialog);tableform.buttons_bind(buttons);tableform.table_bind(table,buttons);$("#type").change(movements.type_change);$("#returndate").change(movements.returndate_change);$("#person").personchooser().bind("personchooserchange",function(event,rec){lastperson=rec;tableform.dialog_error("");if(rec.ISBANNED==1){if(config.bool("WarnBannedOwner")){tableform.dialog_error(_("This person has been banned from adopting animals."));return;}}
if(rec.INVESTIGATION>0){tableform.dialog_error(_("This person has been under investigation"));return;}
if(format.postcode_prefix($(".animalchooser-oopostcode").val())==format.postcode_prefix(rec.OWNERPOSTCODE)||format.postcode_prefix($(".animalchooser-bipostcode").val())==format.postcode_prefix(rec.OWNERPOSTCODE)){if(config.bool("WarnOOPostcode")){tableform.dialog_error(_("This person lives in the same area as the person who brought the animal to the shelter."));return;}}
if(rec.IDCHECK==0){if(config.bool("WarnNoHomeCheck")){tableform.dialog_error(_("This person has not passed a homecheck."));return;}}});$("#person").personchooser().bind("personchooserloaded",function(event,rec){lastperson=rec;});$("#person").personchooser().bind("personchooserclear",function(event,rec){tableform.dialog_error("");});$("#animal").animalchooser().bind("animalchooserchange",function(event,rec){lastanimal=rec;});$("#animal").animalchooser().bind("animalchooserloaded",function(event,rec){lastanimal=rec;});$("#retailer").personchooser().bind("personchooserchange",function(event,rec){lastretailer=rec;});$("#retailer").personchooser().bind("personchooserloaded",function(event,rec){lastretailer=rec;});$("#insurance").after('<button id="button-insurance">'+_("Issue a new insurance number for this animal/adoption")+'</button>');$("#button-insurance").button({icons:{primary:"ui-icon-cart"},text:false}).click(function(){common.ajax_post("animal_movements","mode=insurance",function(result){$("#insurance").val(result);},function(response){tableform.dialog_error(response);});});if(!config.bool("UseAutoInsurance")){$("#button-insurance").button("disable");}
if(config.bool("DontShowInsurance")){$("#insurance").closest("tr").hide();}},validation:function(){if($("#type").val()==0&&$("#reservationdate").val()==""){tableform.dialog_error(_("A movement must have a reservation date or type."));$("label[for='reservation']").addClass("ui-state-error-text");$("#reservationdate").focus();return false;}
if($("#person").val()==""){var mt=$("#type").val();if(mt!=4&&mt!=6&&mt!=7){tableform.dialog_error(_("This type of movement requires a person."));$("label[for='person']").addClass("ui-state-error-text");$("#person").focus();return false;}}
if($("#animal").val()==""){tableform.dialog_error(_("Movements require an animal"));$("label[for='animal']").addClass("ui-state-error-text");$("#animal").focus();return false;}
return true;},set_extra_fields:function(row){row.ANIMALNAME=lastanimal.ANIMALNAME;row.SHELTERCODE=lastanimal.SHELTERCODE;if(lastperson){row.OWNERNAME=lastperson.OWNERNAME;row.OWNERADDRESS=lastperson.OWNERADDRESS;row.HOMETELEPHONE=lastperson.HOMETELEPHONE;row.WORKTELEPHONE=lastperson.WORKTELEPHONE;row.MOBILETELEPHONE=lastperson.MOBILETELEPHONE;}
else{row.OWNERNAME="";row.OWNERADDRESS="";row.HOMETELEPHONE="";row.WORKTELEPHONE="";row.MOBILETELEPHONE="";}
if(lastretailer){row.RETAILERNAME=lastretailer.OWNERNAME;}
else{row.RETAILERNAME="";}
row.AGEGROUP=lastanimal.AGEGROUP;row.SEX=lastanimal.SEXNAME;row.SPECIESNAME=lastanimal.SPECIESNAME;row.MOVEMENTNAME=common.get_field(controller.movementtypes,row.MOVEMENTTYPE,"MOVEMENTTYPE");if(row.RESERVATIONDATE!=null&&row.RESERVATIONCANCELLEDDATE==null){row.MOVEMENTNAME=common.get_field(controller.movementtypes,9,"MOVEMENTTYPE");}
if(row.RESERVATIONDATE!=null&&row.RESERVATIONCANCELLEDDATE!=null){row.MOVEMENTNAME=common.get_field(controller.movementtypes,10,"MOVEMENTTYPE");}},type_change:function(){var mt=$("#type").val();$("#trial").closest("tr").hide();$("#trialenddate").closest("tr").hide();if(config.bool("TrialAdoptions")&&mt==1){$("#trial").closest("tr").fadeIn();$("#trialenddate").closest("tr").fadeIn();}
else{$("#trial").closest("tr").hide();$("#trialenddate").closest("tr").hide();}
$("#permanentfoster").closest("tr").hide();if(mt==2){$("#permanentfoster").closest("tr").fadeIn();}
$("#retailer").closest("tr").hide();if(mt==1&&!config.bool("DisableRetailer")){$("#retailer").closest("tr").fadeIn();}
$("#person").closest("tr").fadeIn();if(mt==4||mt==6||mt==7){$("#person").closest("tr").fadeOut();}},returndate_change:function(){if($("#returndate").val()){$("#returncategory").closest("tr").fadeIn();$("#reason").closest("tr").fadeIn();}
else{$("#returncategory").closest("tr").fadeOut();$("#reason").closest("tr").fadeOut();}}};common.module(movements,"movements",common.current_url().indexOf("book")!=-1?"book":"formtab");});